<!DOCTYPE html>
<html>
<head>
    <title>PeerJS Test</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <h1>PeerJS Connection Test</h1>
    <div>
        <h2>Your ID: <span id="myId">Connecting...</span></h2>
        <input type="text" id="otherId" placeholder="Enter other peer ID">
        <button onclick="connectPeer()">Connect</button>
        <button onclick="callPeer()">Call</button>
    </div>
    <div id="status"></div>
    <video id="localVideo" autoplay muted style="width: 300px;"></video>
    <video id="remoteVideo" autoplay style="width: 300px;"></video>

    <script>
        let myPeer;
        let localStream;
        let currentCall;

        // Initialize peer with same config as your app
        const peerId = Math.random().toString(36).substring(7);
        myPeer = new Peer(peerId, {
            host: '0.peerjs.com',
            port: 443,
            secure: true,
            debug: 3,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        myPeer.on('open', id => {
            document.getElementById('myId').textContent = id;
            console.log('My peer ID is: ' + id);
            addStatus('Connected to PeerJS server with ID: ' + id);
        });

        myPeer.on('error', err => {
            console.error('PeerJS error:', err);
            addStatus('Error: ' + err.type);
        });

        myPeer.on('call', call => {
            console.log('Receiving call from', call.peer);
            addStatus('Incoming call from ' + call.peer);
            
            if (localStream) {
                call.answer(localStream);
                call.on('stream', remoteStream => {
                    console.log('Got remote stream');
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    addStatus('Connected to ' + call.peer);
                });
            } else {
                addStatus('No local stream to answer with');
            }
        });

        // Get user media
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
            .then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                addStatus('Got local video stream');
            })
            .catch(err => {
                console.error('Failed to get user media:', err);
                addStatus('Failed to get camera: ' + err.message);
            });

        function connectPeer() {
            const otherId = document.getElementById('otherId').value;
            if (!otherId) {
                alert('Please enter other peer ID');
                return;
            }
            
            const conn = myPeer.connect(otherId);
            conn.on('open', () => {
                addStatus('Data connection opened with ' + otherId);
                conn.send('Hello from ' + myPeer.id);
            });
        }

        function callPeer() {
            const otherId = document.getElementById('otherId').value;
            if (!otherId) {
                alert('Please enter other peer ID');
                return;
            }
            
            if (!localStream) {
                alert('No local stream available');
                return;
            }
            
            console.log('Calling', otherId);
            addStatus('Calling ' + otherId);
            
            const call = myPeer.call(otherId, localStream);
            currentCall = call;
            
            call.on('stream', remoteStream => {
                console.log('Got remote stream from', otherId);
                document.getElementById('remoteVideo').srcObject = remoteStream;
                addStatus('Connected to ' + otherId);
            });
            
            call.on('error', err => {
                console.error('Call error:', err);
                addStatus('Call error: ' + err);
            });
            
            call.on('close', () => {
                addStatus('Call closed with ' + otherId);
            });
        }

        function addStatus(msg) {
            const status = document.getElementById('status');
            const p = document.createElement('p');
            p.textContent = new Date().toLocaleTimeString() + ': ' + msg;
            status.appendChild(p);
        }
    </script>
</body>
</html>
